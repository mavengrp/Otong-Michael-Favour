<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otong Micheal Favor | Legal Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="Fm_Bg.jpg" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        h1, h2, .serif { font-family: 'Playfair Display', serif; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <nav class="flex justify-between items-center px-4 md:px-10 py-4 md:py-6 bg-white border-b border-slate-200 sticky top-0 z-50">
        <div id="site-logo" class="text-lg md:text-2xl font-bold tracking-tighter uppercase serif text-[#4A0404]">Otong Micheal Favor</div>
        <button id="mobile-menu-btn" class="md:hidden text-2xl text-[#4A0404]">☰</button>
        <div id="nav-menu" class="hidden md:flex space-x-4 md:space-x-8 font-medium text-xs md:text-sm uppercase tracking-widest">
            <a href="#about" class="hover:text-[#4A0404] transition">About</a>
            <a href="#articles" class="hover:text-[#4A0404] transition">Insights</a>
            <a href="mailto:michealfavourotong@gmail.com" class="bg-[#4A0404] text-white px-4 md:px-6 py-2 md:py-3 rounded-sm hover:bg-[#3A0303] transition text-xs md:text-sm">Contact</a>
            <button id="login-btn" class="hover:text-[#4A0404] transition">Admin</button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-nav" class="hidden md:hidden bg-white border-b border-slate-200 px-4 py-4 space-y-3 text-sm">
        <a href="#about" class="block hover:text-[#4A0404] transition py-2">About</a>
        <a href="#articles" class="block hover:text-[#4A0404] transition py-2">Insights</a>
        <a href="mailto:michealfavourotong@email.com" class="block bg-[#4A0404] text-white px-4 py-2 rounded-sm hover:bg-[#3A0303] transition text-center">Contact</a>
        <button id="login-btn-mobile" class="block w-full text-left hover:text-[#4A0404] transition py-2">Admin Login</button>
    </div>

    <div id="admin-bar" class="bg-yellow-100 p-2 text-center hidden flex justify-center gap-4 border-b border-yellow-200">
        <span class="font-bold">ADMIN MODE:</span>
        <button onclick="openModal('add-article-modal')" class="underline text-blue-700">Add New Article</button>
        <button onclick="openModal('edit-about-modal')" class="underline text-green-700">Edit About</button>
        <button onclick="logout()" class="underline text-red-700">Logout</button>
    </div>

    <div id="edit-about-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] p-4">
        <div class="bg-white p-6 md:p-8 rounded shadow-lg max-w-lg w-full text-center max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg md:text-xl mb-4 serif">Edit "About" Section</h3>
            <textarea id="about-content" class="w-full p-2 border mb-4 rounded text-sm md:text-base" rows="10"></textarea>
            <button id="save-about-btn" class="bg-[#4A0404] text-white w-full py-2 rounded text-sm md:text-base">Save</button>
            <button onclick="closeModal('edit-about-modal')" class="mt-2 text-sm text-slate-400">Cancel</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] p-4">
        <div class="bg-white p-6 md:p-8 rounded shadow-lg max-w-sm w-full text-center">
            <h3 class="text-lg md:text-xl mb-4 serif">Authorized Access Only</h3>
            <input id="admin-email" type="email" placeholder="Admin email" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <input id="admin-password" type="password" placeholder="Password" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <button id="submit-login" class="bg-[#4A0404] text-white w-full py-2 rounded text-sm md:text-base">Enter Dashboard</button>
            <button onclick="closeModal('login-modal')" class="mt-2 text-sm text-slate-400">Cancel</button>
        </div>
    </div>

    <div id="add-article-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] p-4">
        <div class="bg-white p-6 md:p-8 rounded shadow-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg md:text-xl mb-4 serif text-[#4A0404]">Publish New Insight</h3>
            <input id="art-title" type="text" placeholder="Title" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <input id="art-category" type="text" placeholder="Category (e.g. Corporate Law)" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <textarea id="art-summary" placeholder="Short Summary" class="w-full p-2 border mb-4 rounded text-sm md:text-base"></textarea>
            <textarea id="art-content" placeholder="Full Article Content" class="w-full p-2 border mb-4 rounded text-sm md:text-base" rows="6"></textarea>
            <input id="art-img-url" type="text" placeholder="Image URL (Link to your picture)" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <label class="block text-xs md:text-sm text-slate-600 mb-1">Or upload image from your device</label>
            <input id="art-img-file" type="file" accept="image/*" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <label class="block text-xs md:text-sm text-slate-600 mb-1">Attach PDF / Word document (optional)</label>
            <input id="art-attachment" type="file" accept=".pdf,.doc,.docx" class="w-full p-2 border mb-4 rounded text-sm md:text-base">
            <input id="editing-id" type="hidden" value="">
            <button id="publish-btn" class="bg-[#4A0404] text-white px-6 py-2 rounded w-full text-sm md:text-base">Publish to Website</button>
            <button onclick="closeModal('add-article-modal')" class="w-full mt-2 text-slate-400 text-sm">Discard</button>
        </div>
    </div>

    <div id="article-detail-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] overflow-y-auto p-4">
        <div class="bg-white p-6 md:p-8 rounded shadow-lg max-w-2xl w-full my-6 md:my-10">
            <button onclick="closeModal('article-detail-modal')" class="float-right text-2xl text-slate-400">&times;</button>
            <h2 id="detail-title" class="text-2xl md:text-3xl mb-2 serif text-[#4A0404]"></h2>
            <span id="detail-category" class="text-xs font-bold text-[#4A0404] uppercase tracking-tighter"></span>
            <div id="detail-image-container" class="my-4 md:my-6">
                <img id="detail-image" src="" alt="" class="w-full h-48 md:h-96 object-cover rounded">
            </div>
            <p id="detail-summary" class="text-base md:text-lg font-semibold mb-3 md:mb-4"></p>
            <div id="detail-content" class="text-sm md:text-base text-slate-700 leading-relaxed mb-4 md:mb-6"></div>
            <div id="detail-attachment-container" class="hidden">
                <a id="detail-attachment" href="" target="_blank" class="inline-block bg-[#4A0404] text-white px-4 md:px-6 py-2 md:py-3 rounded hover:bg-[#3A0303] transition text-sm md:text-base">Download Attachment</a>
            </div>
        </div>
    </div>

    <header class="relative bg-[#4A0404] min-h-[400px] md:min-h-[500px] flex items-center">
        <div class="container mx-auto px-4 md:px-10 grid md:grid-cols-2 gap-6 md:gap-10 items-center">
            <div class="text-white py-12 md:py-20">
                <h1 class="text-3xl md:text-6xl leading-tight mb-4 md:mb-6 serif">Strategy Focused on <br><span class="italic text-slate-400 text-2xl md:text-5xl">Results.</span></h1>
                <p class="text-base md:text-lg text-slate-300 max-w-md mb-6 md:mb-8 italic">"Dedicated to providing clarity in complex legal environments."</p>
                <a href="#articles" class="border-2 border-white px-6 md:px-8 py-2 md:py-3 text-xs md:text-sm uppercase tracking-widest hover:bg-white hover:text-[#4A0404] transition inline-block">Read My Insights</a>
            </div>
            <div class="hidden md:block h-[400px] md:h-[500px] bg-cover bg-center rounded shadow-2xl" style="background-image: url('./Profile Photo.png');"></div>
        </div>
    </header>

    <section id="about" class="bg-white py-12 md:py-20">
        <div class="container mx-auto px-4 md:px-10 max-w-4xl">
            <h2 class="text-2xl md:text-4xl mb-6 md:mb-8 serif border-b pb-3 md:pb-4">Decoding Otong</h2>
            <div class="text-base md:text-lg text-slate-700 leading-relaxed space-y-3 md:space-y-4">
                <p>
                    Otong Michael Favour is a dedicated legal and tax proffesional specializing in Alternative Disbute Resolution(ADR) and taxation,
                    with a strong commitment to delivering practical innovative solutions at the intersection of law and finance. 
                    An Associate of the Chattered Institute of rbitrators (CIArb), trained by CIArb Kenya through the Uganda Chapter, 
                    he brings solid expertise in arbitration, mediation, and negociation, enabling the efficient and equitable resolution of disputes.
                </p>
                <p>
                    His taxation practice was shapped through experience at Godena Associates, one of Uganda's leading tax-specialized law firms, 
                    where he gained hands-on experience in tax advisory, compliance, and dispute resolution.
                    He is well-versed in Uganda's tax framework, including the Tax procedures Code Act, and Practical exposure to regional tax jurisprudence.
                </p>
                <p>
                    Currently, Otong is Pursuing a Master of Business administration (MBA) with a focus of Finance and Taxtion, 
                    strengthening jis understanding of financial strategy, tax planning and optimization.
                    He is also undertaking a Diploma in Tax and Revenue Adminstration (DITRA) at East African School of Taxation, 
                    further enhancing his competence in tax policy, revenue mnagement and regulatory compliance.
                </p>
                <p>
                    Driven by excellence, collaboration and innovation, Otong is passionate about delivering impactful results whether resolving complex tax disputes or facilitating ambicable settlements through ADR.
                    He welcomes opportunities in arbitration, tax advisory, and financial strategy, and is eager to connect with proffessionals across law, finance and ADR in Africa and beyond to explore meaningful collaboration and effective solutions.
                </p>
            </div>
        </div>
    </section>

    <section id="articles" class="container mx-auto px-4 md:px-10 py-12 md:py-20">
        <h2 class="text-2xl md:text-4xl mb-8 md:mb-12 serif">Legal Insights & Publications</h2>
        <div id="article-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 md:gap-10">
            </div>
    </section>

    <footer class="bg-[#4A0404] text-white py-10 text-center">
        <p class="text-slate-500 text-xs tracking-widest uppercase">© 2026 OTONG & ASSOCIATES. ALL RIGHTS RESERVED.</p>
    </footer>

    <script>
        // 1. SUPABASE CONFIGURATION
        const _supabase = supabase.createClient(
            'https://wdgfwkmxbxlbrfxwmyst.supabase.co', 
            'sb_publishable_XLZnSi1DbbXetlxueXsJKA_ZCKxQNuI'
        );

        let isLoggedIn = false;

        // Basic UUID regex (simple validation)
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

        // Bucket names configuration
        const BUCKETS = {
            images: 'article-images',
            pdfs: 'pdf-storage'
        };

        // Generate safe storage path with article ID and timestamp
        function generateStoragePath(articleId, filename) {
            const timestamp = Date.now();
            const clean = filename.replace(/\\/g, '/').split('/').pop() || filename;
            return `articles/${articleId}/${timestamp}_${clean}`;
        }

        // Upload file to Supabase storage (returns bucket, path, publicUrl, error)
        async function uploadToStorage(file, options) {
            if (!file) return { bucket: null, path: null, publicUrl: null, error: 'No file provided' };
            
            const bucketName = options.bucketName || BUCKETS.pdfs;
            const filename = options.filename || file.name;
            const path = generateStoragePath(options.articleId, filename);
            
            try {
                const { data, error: uploadError } = await _supabase.storage
                    .from(bucketName)
                    .upload(path, file, { cacheControl: '3600', upsert: false });
                
                if (uploadError) {
                    console.warn('Upload error', uploadError);
                    return { bucket: bucketName, path: null, publicUrl: null, error: uploadError.message };
                }
                
                const { data: publicData, error: publicError } = _supabase.storage
                    .from(bucketName)
                    .getPublicUrl(path);
                
                if (publicError) {
                    return { bucket: bucketName, path, publicUrl: null, error: publicError.message };
                }
                
                return { bucket: bucketName, path, publicUrl: publicData.publicUrl, error: null };
            } catch (e) {
                console.warn('Storage exception', e);
                return { bucket: bucketName, path: null, publicUrl: null, error: e.message };
            }
        }

        // Extract object path from Supabase public URL for a given bucket
        function extractPathFromPublicUrl(url, bucketName) {
            try {
                const marker = `/${bucketName}/`;
                let idx = url.indexOf(marker);
                if (idx === -1) {
                    // try encoded bucket name (spaces encoded, etc.)
                    const encoded = `/${encodeURIComponent(bucketName)}/`;
                    idx = url.indexOf(encoded);
                    if (idx === -1) return null;
                    return url.substring(idx + encoded.length);
                }
                return url.substring(idx + marker.length);
            } catch (e) {
                return null;
            }
        }

        // 2. FETCH ARTICLES (READ)
        async function fetchArticles() {
            const grid = document.getElementById('article-grid');
            if (!grid) return;
            grid.innerHTML = '<p class="col-span-3 text-center text-slate-400">Loading articles...</p>';

            const { data: articles, error } = await _supabase
                .from('articles')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                grid.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                console.error('fetchArticles error:', error);
                return;
            }

            console.debug('fetchArticles -> articles:', articles);

            if (!articles || articles.length === 0) {
                grid.innerHTML = '<p class="col-span-3 text-center text-slate-400">No articles found.</p>';
                return;
            }

            // Build markup with data-id attributes for delete
            grid.innerHTML = (articles || []).map(post => {
                // Use a safe fallback id (null will render as empty string)
                const id = post.id || '';
                return `
                    <article class="article-card bg-white border border-slate-200 group cursor-pointer hover:shadow-xl transition-all overflow-hidden flex flex-col" data-article-id="${id}" onclick="openArticleDetail('${id}')">
                        <div class="h-48 overflow-hidden bg-slate-200">
                            <img src="${post.image_url || 'https://via.placeholder.com/400x250'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" alt="">
                        </div>
                        <div class="p-6 flex-grow">
                            <span class="text-xs font-bold text-[#4A0404] uppercase tracking-tighter">${post.category || ''}</span>
                            <h3 class="text-xl mt-2 mb-3 font-semibold serif">${post.title || ''}</h3>
                            <p class="text-slate-600 text-sm mb-4 line-clamp-2">${post.summary || ''}</p>
                            ${post.attachment_public_url ? `<a href="${post.attachment_public_url}" target="_blank" class="text-sm text-blue-600 underline" onclick="event.stopPropagation();">Download Attachment</a>` : ''}
                        </div>
                        ${isLoggedIn ? `
                            <div class="p-4 bg-slate-50 border-t flex gap-4">
                                <button class="edit-article-btn text-blue-600 text-xs font-bold uppercase hover:underline" type="button" onclick="event.stopPropagation();">Edit</button>
                                <button class="delete-article-btn text-red-600 text-xs font-bold uppercase hover:underline" type="button" onclick="event.stopPropagation();">Delete</button>
                            </div>
                        ` : ''}
                    </article>
                `;
            }).join('');
        }

        // 3. PUBLISH ARTICLE (CREATE / UPDATE)
        document.getElementById('publish-btn').addEventListener('click', async () => {
            if (!isLoggedIn) { alert('Please log in as admin to publish.'); return; }

            const title = document.getElementById('art-title').value.trim();
            const category = document.getElementById('art-category').value.trim();
            const summary = document.getElementById('art-summary').value.trim();
            const content = document.getElementById('art-content').value.trim();
            const image_url_raw = document.getElementById('art-img-url').value.trim();
            const imgFile = document.getElementById('art-img-file').files[0];
            const attachmentFile = document.getElementById('art-attachment').files[0];
            const id = document.getElementById('editing-id').value || null;

            // Content is optional if attachment is provided
            if (!title || !category || !summary || (!content && !attachmentFile)) {
                alert('Please fill in all required fields, or provide a document.');
                return;
            }

            // Use article ID or generate a temporary one for new articles
            const articleId = id || `temp_${Date.now()}`;

            // Upload image file if provided (prefer file over URL)
            let image_url_final = image_url_raw || null;
            if (imgFile) {
                const res = await uploadToStorage(imgFile, { 
                    articleId, 
                    filename: imgFile.name, 
                    bucketName: BUCKETS.images 
                });
                if (res.error) {
                    alert('Image upload failed: ' + res.error);
                    return;
                }
                if (res.publicUrl) { image_url_final = res.publicUrl; }
            }

            // Upload attachment if provided
            let attachment_url = null;
            let attachment_path = null;
            let attachment_bucket = null;
            if (attachmentFile) {
                const res = await uploadToStorage(attachmentFile, { 
                    articleId, 
                    filename: attachmentFile.name, 
                    bucketName: BUCKETS.pdfs 
                });
                if (res.error) {
                    alert('Attachment upload failed: ' + res.error);
                    return;
                }
                if (res.publicUrl) { 
                    attachment_url = res.publicUrl;
                    attachment_path = res.path;
                    attachment_bucket = res.bucket;
                }
            }

            // Build payload
            const payload = {
                title,
                category,
                summary,
                content: content || null,
                image_url: image_url_final,
                attachment_public_url: attachment_url,
                attachment_path: attachment_path,
                attachment_bucket: attachment_bucket,
                created_at: new Date().toISOString()
            };

            if (id) {
                // Update existing article
                const { error } = await _supabase.from('articles').update(payload).eq('id', id);
                if (error) { alert('Update failed: ' + error.message); return; }
                alert('Article updated');
            } else {
                // Create new article
                const { error } = await _supabase.from('articles').insert([payload]);
                if (error) { alert('Publish failed: ' + error.message); return; }
                alert('Article Published Live!');
            }

            // Reset form
            document.getElementById('art-title').value = '';
            document.getElementById('art-category').value = '';
            document.getElementById('art-summary').value = '';
            document.getElementById('art-content').value = '';
            document.getElementById('art-img-url').value = '';
            document.getElementById('art-img-file').value = '';
            document.getElementById('art-attachment').value = '';
            document.getElementById('editing-id').value = '';
            closeModal('add-article-modal');
            fetchArticles();
        });

        // 4. DELETE ARTICLE (with UUID validation)
        async function deleteArticle(id) {
            if (!id) {
                alert('Delete failed: missing article id');
                console.error('Delete failed: missing id');
                return;
            }
            if (!uuidRegex.test(id)) {
                alert('Delete failed: invalid article id format');
                console.error('Delete failed: invalid id format:', id);
                return;
            }

            if (!confirm('Permanently delete this article?')) return;

            // Ensure user is authenticated
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session || !session.user) {
                alert('You must be signed in to delete articles.');
                openModal('login-modal');
                return;
            }

            // Fetch article to get attachment metadata for cleanup
            const { data: article, error: fetchErr } = await _supabase.from('articles').select('*').eq('id', id).single();
            if (fetchErr) { console.warn('Fetch warning (delete can proceed):', fetchErr); }
            else {
                try {
                    // Delete image if exists
                    if (article.image_url) {
                        const imgPath = extractPathFromPublicUrl(article.image_url, BUCKETS.images);
                        if (imgPath) await _supabase.storage.from(BUCKETS.images).remove([imgPath]);
                    }
                    // Delete attachment using stored path and bucket
                    if (article.attachment_path && article.attachment_bucket) {
                        await _supabase.storage.from(article.attachment_bucket).remove([article.attachment_path]);
                    } else if (article.attachment_public_url) {
                        // Fallback: extract path from public URL
                        const attPath = extractPathFromPublicUrl(article.attachment_public_url, BUCKETS.pdfs);
                        if (attPath) await _supabase.storage.from(BUCKETS.pdfs).remove([attPath]);
                    }
                } catch (e) { console.warn('Error removing storage files', e); }
            }

            // Perform delete
            const { error } = await _supabase.from('articles').delete().eq('id', id);
            if (error) {
                alert('Delete failed: ' + error.message);
                console.error('Supabase delete error:', error);
            } else {
                const articleEl = document.querySelector(`[data-article-id="${id}"]`);
                if (articleEl) articleEl.remove();
            }
        }

        // 5. EDIT ARTICLE
        async function editArticle(id) {
            if (!id) {
                alert('Edit failed: missing article id');
                return;
            }
            if (!uuidRegex.test(id)) {
                alert('Edit failed: invalid article id format');
                return;
            }
            const { data: article, error } = await _supabase.from('articles').select('*').eq('id', id).single();
            if (error) { alert('Fetch failed: ' + error.message); console.error('Fetch error:', error); return; }
            document.getElementById('art-title').value = article.title || '';
            document.getElementById('art-category').value = article.category || '';
            document.getElementById('art-summary').value = article.summary || '';
            document.getElementById('art-content').value = article.content || '';
            document.getElementById('art-img-url').value = article.image_url || '';
            document.getElementById('editing-id').value = article.id;
            openModal('add-article-modal');
        }

        // Open article detail modal
        async function openArticleDetail(id) {
            if (!id) { alert('Article not found'); return; }
            const { data: article, error } = await _supabase.from('articles').select('*').eq('id', id).single();
            if (error) { alert('Failed to load article: ' + error.message); return; }
            
            // Populate detail modal
            document.getElementById('detail-title').textContent = article.title || '';
            document.getElementById('detail-category').textContent = article.category || '';
            document.getElementById('detail-summary').textContent = article.summary || '';
            document.getElementById('detail-content').textContent = article.content || '';
            
            // Show or hide image
            const imgContainer = document.getElementById('detail-image-container');
            if (article.image_url) {
                document.getElementById('detail-image').src = article.image_url;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.style.display = 'none';
            }
            
            // Show or hide attachment
            const attachContainer = document.getElementById('detail-attachment-container');
            if (article.attachment_public_url) {
                document.getElementById('detail-attachment').href = article.attachment_public_url;
                attachContainer.style.display = 'block';
            } else {
                attachContainer.style.display = 'none';
            }
            
            openModal('article-detail-modal');
        }

        // Delegated click listener for edit and delete buttons
        document.addEventListener('click', async (e) => {
            const target = e.target;
            if (!target) return;

            // Match the edit button
            if (target.matches('.edit-article-btn')) {
                const articleEl = target.closest('.article-card');
                const id = articleEl?.dataset?.articleId;
                if (id) editArticle(id);
            }

            // Match the delete button
            if (target.matches('.delete-article-btn')) {
                const articleEl = target.closest('.article-card');
                const id = articleEl?.dataset?.articleId;
                if (id) deleteArticle(id);
            }
        });

        // 6. ADMIN LOGIC + AUTH
        document.getElementById('login-btn').addEventListener('click', () => openModal('login-modal'));

        document.getElementById('submit-login').addEventListener('click', async () => {
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;
            if (!email || !password) { alert('Please enter email and password'); return; }
            try {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                if (error) { alert('Login failed: ' + error.message); return; }
                if (data && data.user) {
                    isLoggedIn = true;
                    document.getElementById('admin-bar').classList.remove('hidden');
                    document.getElementById('publish-btn').disabled = false;
                    closeModal('login-modal');
                    fetchArticles();
                } else alert('Login failed');
            } catch (err) { alert('Login error: ' + err.message); }
        });

        async function logout() {
            try { await _supabase.auth.signOut(); } catch (err) { console.warn('Sign out error', err); }
            isLoggedIn = false;
            document.getElementById('admin-bar').classList.add('hidden');
            document.getElementById('publish-btn').disabled = true;
            fetchArticles();
        }

        // ABOUT editing (stored locally)
        function loadAbout() {
            const saved = localStorage.getItem('micheal_about');
            if (saved) {
                const container = document.querySelector('#about .text-lg');
                if (container) container.innerHTML = saved;
                document.getElementById('about-content').value = saved;
            } else {
                // populate textarea with existing content
                const container = document.querySelector('#about .text-lg');
                if (container) document.getElementById('about-content').value = container.innerHTML.trim();
            }
        }

        document.getElementById('save-about-btn').addEventListener('click', () => {
            if (!isLoggedIn) { alert('Please log in to edit About.'); return; }
            const val = document.getElementById('about-content').value.trim();
            localStorage.setItem('micheal_about', val);
            const container = document.querySelector('#about .text-lg');
            if (container) container.innerHTML = val;
            closeModal('edit-about-modal');
            alert('About section updated (stored locally).');
        });

        // UTILS
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // MOBILE MENU TOGGLE
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const mobileNav = document.getElementById('mobile-nav');
            mobileNav.classList.toggle('hidden');
        });

        // Close mobile menu when navigating
        document.querySelectorAll('#mobile-nav a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('mobile-nav').classList.add('hidden');
            });
        });

        // Mobile login button
        document.getElementById('login-btn-mobile').addEventListener('click', () => {
            document.getElementById('mobile-nav').classList.add('hidden');
            openModal('login-modal');
        });

        // RUN ON LOAD
        (async function init() {
            // disable publish until authenticated
            document.getElementById('publish-btn').disabled = true;
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                if (session && session.user) {
                    isLoggedIn = true;
                    document.getElementById('admin-bar').classList.remove('hidden');
                    document.getElementById('publish-btn').disabled = false;
                }
            } catch (err) { /* ignore */ }
            loadAbout();
            fetchArticles();
        })();
    </script>
</body>
</html>
